# HTL OOE ROS Node for Raspberry Pi
Operating the Node requires the HAT Hardware from the [board Repository](https://github.com/htl-ooe/board "HAT pcb").
We assume that you are familiar with the basic commands to operate Linux.

## Installing the Operating System

### Downloading the Operating System
We use the [Ubiquity Robotics OS](https://downloads.ubiquityrobotics.com/pi.html "Ubiquity Robotics OS") as a base for our board.
Look at [Installing operating system images](https://www.raspberrypi.org/documentation/installation/installing-images/README.md "Installing operating system images") for how to flash the Micro SD Card.
When using a SD Card to Micro SD Card Adapter, there is a Switch called **LOCK**. Take care, that the Switch is in the unlocked position.
When you access the Micro SD Card using Microsoft Windows, it asks for **formatting** the Device. **Don't do this!**
### Updating the Operating System and Installing Software
Using **apt-get** (Advanced Packaging Tool) you can update the Operating System and install Software.
apt-get needs the time and date to be set to an actual value! You can do this by typing
```console
ubuntu@ubiquityrobot:~ $ sudo date -s "7 Dec 2020 09:20:00"
ubuntu@ubiquityrobot:~ $ date # returns current time and date
```
If you have a ntp timeserver up and running you can edit
```console
ubuntu@ubiquityrobot:~ $ sudo nano /etc/systemd/timesyncd.conf
```
to update the time via network.

To do the necessary software Maintenance you should enter
```console
ubuntu@ubiquityrobot:~ $ sudo apt-get -y update && sudo apt-get -y dist-upgrade
```
Setting the Time Zone and enabling ntp (network time protocol)
```console
ubuntu@ubiquityrobot:~ $ sudo timedatectl set-timezone Europe/Vienna
ubuntu@ubiquityrobot:~ $ sudo timedatectl set-ntp true
```
To remove the folder generated by Windows just type
```console
ubuntu@ubiquityrobot:~ [ -d "/boot/System Volume Information" ] && sudo rm -r "/boot/System Volume Information"
```
To avoid damage of the Micro SD Card by too many write operations you can edit
```console
ubuntu@ubiquityrobot:~ sudo nano /etc/systemd/journald.conf
```
and add/change
```console
Storage=volatile
ForwardToSyslog=no
```
Then we configure the Ubiquity Robotics OS to not start services we do not need and enable the pigpiod service
```console
ubuntu@ubiquityrobot:~ sudo systemctl stop magni-base
ubuntu@ubiquityrobot:~ sudo systemctl disable magni-base
ubuntu@ubiquityrobot:~ sudo systemctl disable hwclock-sync.service
ubuntu@ubiquityrobot:~ sudo systemctl enable pigpiod.service
```
and disable stuff in config.txt
```console
ubuntu@ubiquityrobot:~ sudo nano /boot/config.txt
```
comment out:
```#dtparam=audio=on```
```#dtparam=i2c_arm=on```
```#dtoverlay=pi3-miniuart-bt```
```#dtoverlay=i2c-rtc,mcp7940x```
```#dtoverlay=ubiquity-led-buttons```
#### Reboot the system to load/unload the newly insalled stuff
```
ubuntu@ubiquityrobot:~ $ sudo reboot
```

## Device Tree
To manage ressources Linux uses the [Device Tree](https://www.raspberrypi.org/documentation/configuration/device-tree.md "Device Tree"). Parts of it are configured in the File [config.txt](https://www.raspberrypi.org/documentation/configuration/config-txt/README.md "config.txt").
You can also add devices via the EEPROM on a [HAT](https://github.com/raspberrypi/hats "HAT").
To configure devices [virtual Filesystems](https://en.wikipedia.org/wiki/Virtual_file_system "virtual Filesystems") (/dev, /sys, /proc) are frequently used.
### HAT
We assume a properly programmed EEPROM according to [board Repository](https://github.com/htl-ooe/board "HAT pcb").
Clone the Repository to the Raspberry Pi
```console
ubuntu@ubiquityrobot:~ $ git clone https://github.com/htl-ooe/ros.git
```
#### PWM
Our HAT uses PWM channels. The **root** user can access the onboard chanels.
If the user **ubuntu** should use the pripheral, you have to give him the rights to do this:
Edit the File `/etc/udev/rules.d/99-com.rules`
```console
ubuntu@ubiquityrobot:~ $ sudo nano /etc/udev/rules.d/99-com.rules
```
and add
```code
    SUBSYSTEM=="pwm*", PROGRAM="/bin/sh -c '\
        chown -R root:gpio /sys/class/pwm && chmod -R 770 /sys/class/pwm;\
        chown -R root:gpio /sys/devices/platform/soc/*.pwm/pwm/pwmchip* && chmod -R 770 /sys/devices/platform/soc/*.pwm/pwm/pwmchip*;\
        chown -R root:gpio /sys/devices/platform/soc/*.i2c/i2c*/*/pwm/pwmchip* && chmod -R 770 /sys/devices/platform/soc/*.i2c/i2c*/*/pwm/pwmchip*\
    '"
```
right after the GPIO Part.
#### Ultrasonic Sensor
To use the SRF04 we have to compile the module, which is not included in the ubuntu build.
```console
ubuntu@ubiquityrobot:~ $ sudo apt-get install -y raspberrypi-kernel-headers
ubuntu@ubiquityrobot:~ $ sudo /home/ubuntu/ros/drivers/install.sh
```
#### Infrared Sensor (remote control)
To use a remote control we have to install software and configure the protocol.
```console
ubuntu@ubiquityrobot:~ $ sudo apt-get install -y ir-keytable python-evdev
```
uncomment and edit **linux,rc-map-name** in the smartcar-V1-x-overlay.dts to a protocol (rc5, nec, etc.) of you needs, it will be loaded at boot time.
Reprogram the HAT EEPROM according to the description in [board Repository](https://github.com/htl-ooe/board "HAT pcb").
To test the IR receiver just type
```
ubuntu@ubiquityrobot:~ $ sudo ir-keytable --protocol=rc-5,jvc,sony,nec,sanyo,rc-6,sharp,xmp -t
```
## ROS Node
move the node to the propper location.
```
ubuntu@ubiquityrobot:~ $ mv ~/ros/htl_ooe_smart_car ~/catkin_ws/src/
```
and install a service to automatically launch the node
```
ubuntu@ubiquityrobot:~ $ sudo cp ~/ros/htl-ooe-smart-car.service /etc/systemd/system/
ubuntu@ubiquityrobot:~ $ sudo systemctl enable htl-ooe-smart-car.service
ubuntu@ubiquityrobot:~ $ sudo cp ~/ros/htl-ooe-smart-car.sh /usr/sbin/htl-ooe-smart-car
ubuntu@ubiquityrobot:~ $ sudo chmod +x /usr/sbin/htl-ooe-smart-car
ubuntu@ubiquityrobot:~ $ sudo systemctl start htl-ooe-smart-car.service
```
Now you can remove unneccesary files
```
ubuntu@ubiquityrobot:~ $ sudo rm -r ~/ros
```
#### Reboot again
```
ubuntu@ubiquityrobot:~ $ sudo reboot
```
## Running and launching nodes
First move to your workspace
```
ubuntu@ubiquityrobot:~ $ cd ~/catkin_ws
```
now you can build and launch nodes with
```
ubuntu@ubiquityrobot:~ $ source ~/catkin_ws/devel/setup.bash && catkin_make && roslaunch htl_ooe_smart_car htl_ooe_smart_car.launch
```
or
```
ubuntu@ubiquityrobot:~ $ roslaunch htl_ooe_smart_car teleop_twist_keyboard.launch
```
to control your car with the keyboard.
To learn more visit [Learn Ubiquity Robots and ROS](https://learn.ubiquityrobotics.com "Learn Ubiquity Robots and ROS").
